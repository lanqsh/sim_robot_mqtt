<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器人管理系统</title>

    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css?v=2.0">
    <link rel="stylesheet" href="../css/pages.css">
    <link rel="stylesheet" href="../css/tables.css">
    <link rel="stylesheet" href="../css/utils.css">
</head>
<body>
    <div class="container">
        <h1>机器人管理系统</h1>

        <!-- 添加机器人表单 -->
        <div class="add-robot-form">
            <div class="collapsible-header" onclick="toggleAddRobotForm()">
                <h2>添加新机器人</h2>
                <span class="collapse-icon" id="addRobotCollapseIcon">▼</span>
            </div>
            <div id="addRobotContent" style="display: none;">
                <div id="message"></div>
                <form id="addRobotForm">
                    <div class="inline-form">
                        <input type="number" id="serialNumber" name="serialNumber" min="1"
                               placeholder="序号（可选）" style="width: 120px;">
                        <input type="text" id="robotName" name="robotName"
                               placeholder="机器人名称（可选）" style="width: 180px;">
                        <div class="form-spacer"></div>
                        <button type="submit" class="btn btn-success">发送请求</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 批量操作区域 -->
        <div class="batch-operations">
            <div class="collapsible-header" onclick="toggleBatchForm()">
                <h2>批量增删机器人</h2>
                <span class="collapse-icon" id="batchCollapseIcon">▼</span>
            </div>
            <div class="batch-controls" id="batchFormContent" style="display: none;">
                <div class="inline-form">
                    <input type="number" id="batchStartSerial" min="1" placeholder="起始序号" style="width: 120px;">
                    <span>~</span>
                    <input type="number" id="batchEndSerial" min="1" placeholder="结束序号" style="width: 120px;">
                    <input type="text" id="batchNamePrefix" placeholder="名称前缀（可选）" style="width: 180px;">
                    <div class="form-spacer"></div>
                    <button class="btn btn-primary" onclick="batchAddRobots()">批量添加</button>
                    <button class="btn btn-danger" onclick="batchDeleteRobots()">批量删除</button>
                </div>
            </div>
        </div>

        <!-- 已移除主区的最近定时任务容器，详情模态中显示 -->

        <!-- 定时启动请求区域 -->
        <div class="schedule-request-section">
            <div class="collapsible-header" onclick="toggleScheduleForm()">
                <h2>定时启动请求</h2>
                <span class="collapse-icon" id="scheduleCollapseIcon">▼</span>
            </div>
            <div class="schedule-controls start-controls" id="scheduleFormContent" style="display: none;">
                <div class="schedule-inline-form start-inline-form">
                    <input type="text" id="scheduleRobotId" placeholder="机器人ID" style="width: 120px;">
                    <span class="or-text">或</span>
                    <input type="number" id="scheduleSerial" min="1" placeholder="序号" style="width: 100px;">
                    <input type="number" id="scheduleId" min="1" max="255" placeholder="定时编号" style="width: 100px;">
                    <select id="scheduleWeekday" style="width: 120px;">
                        <option value="0">星期日</option>
                        <option value="1">星期一</option>
                        <option value="2">星期二</option>
                        <option value="3">星期三</option>
                        <option value="4">星期四</option>
                        <option value="5">星期五</option>
                        <option value="6">星期六</option>
                    </select>
                    <input type="number" id="scheduleHour" min="0" max="23" placeholder="时" style="width: 100px;">
                    <input type="number" id="scheduleMinute" min="0" max="59" placeholder="分" style="width: 100px;">
                    <input type="number" id="scheduleRunCount" min="1" max="255" placeholder="运行次数" style="width: 100px;">
                    <div class="form-spacer"></div>
                    <button class="btn btn-success" onclick="sendScheduleRequest()">发送请求</button>
                </div>
            </div>
        </div>

        <!-- 启动请求区域 -->
        <div class="start-request-section">
            <div class="collapsible-header" onclick="toggleStartForm()">
                <h2>启动请求</h2>
                <span class="collapse-icon" id="startCollapseIcon">▼</span>
            </div>
            <div class="start-controls" id="startFormContent" style="display: none;">
                <div class="start-inline-form">
                    <input type="text" id="startRobotId" placeholder="机器人ID" style="width: 120px;">
                    <span class="or-text">或</span>
                    <input type="number" id="startSerial" min="1" placeholder="序号" style="width: 100px;">
                    <div class="form-spacer"></div>
                    <button class="btn btn-success" onclick="sendStartRequest()">发送请求</button>
                </div>
            </div>
        </div>

        <!-- 校时请求区域 -->
        <div class="timesync-request-section">
            <div class="collapsible-header" onclick="toggleTimeSyncForm()">
                <h2>校时请求</h2>
                <span class="collapse-icon" id="timeSyncCollapseIcon">▼</span>
            </div>
            <div class="timesync-controls" id="timeSyncFormContent" style="display: none;">
                <div class="timesync-inline-form">
                    <input type="text" id="timeSyncRobotId" placeholder="机器人ID" style="width: 120px;">
                    <span class="or-text">或</span>
                    <input type="number" id="timeSyncSerial" min="1" placeholder="序号" style="width: 100px;">
                    <div class="form-spacer"></div>
                    <button class="btn btn-success" onclick="sendTimeSyncRequest()">发送请求</button>
                </div>
            </div>
        </div>

        <!-- FA告警设置区域 -->
        <div class="alarm-section">
            <div class="collapsible-header" onclick="toggleAlarmForm()">
                <h2>告警设置</h2>
                <span class="collapse-icon" id="alarmCollapseIcon">▼</span>
            </div>
            <div class="alarm-controls" id="alarmFormContent" style="display: none;">
                <div class="alarm-top-inputs">
                    <input type="text" id="alarmRobotId" placeholder="机器人ID" style="width: 150px;">
                    <span class="or-text">或</span>
                    <input type="number" id="alarmSerial" min="1" placeholder="序号" style="width: 120px;">
                    <div class="form-spacer"></div>
                    <button class="btn btn-success" onclick="setAlarm()">应用告警</button>
                    <button class="btn btn-secondary" onclick="clearAllAlarms()">清除所有</button>
                </div>

                <!-- 告警类型标签页 -->
                <div class="alarm-tabs">
                    <button class="alarm-tab active" onclick="switchAlarmTab('FA')">FA告警</button>
                    <button class="alarm-tab" onclick="switchAlarmTab('FB')">FB告警</button>
                    <button class="alarm-tab" onclick="switchAlarmTab('FC')">FC告警</button>
                    <button class="alarm-tab" onclick="switchAlarmTab('FD')">FD告警</button>
                </div>

                <!-- FA告警 -->
                <div class="alarm-checkboxes" id="alarm-FA" style="display: block;">
                    <label><input type="checkbox" data-type="FA" data-bit="0"> 设备启用/停用</label>
                    <label><input type="checkbox" data-type="FA" data-bit="1"> 启动队列切换中</label>
                    <label><input type="checkbox" data-type="FA" data-bit="2"> 自动/手动</label>
                    <label><input type="checkbox" data-type="FA" data-bit="3"> 启动失败</label>
                    <label><input type="checkbox" data-type="FA" data-bit="4"> 自动运行中(指清扫中)</label>
                    <label><input type="checkbox" data-type="FA" data-bit="5"> 自动运行完成(指清扫完成)</label>
                    <label><input type="checkbox" data-type="FA" data-bit="6"> 自动运行失败</label>
                    <label><input type="checkbox" data-type="FA" data-bit="7"> 前进</label>
                    <label><input type="checkbox" data-type="FA" data-bit="8"> 后退</label>
                    <label><input type="checkbox" data-type="FA" data-bit="9"> 运行停止</label>
                    <label><input type="checkbox" data-type="FA" data-bit="10"> 近端触发</label>
                    <label><input type="checkbox" data-type="FA" data-bit="11"> 远端触发</label>
                    <label><input type="checkbox" data-type="FA" data-bit="12"> 急停状态</label>
                    <label><input type="checkbox" data-type="FA" data-bit="13"> 自动复位中</label>
                    <label><input type="checkbox" data-type="FA" data-bit="14"> 自动复位完成</label>
                    <label><input type="checkbox" data-type="FA" data-bit="15"> 低电量返回停靠位成功</label>
                    <label><input type="checkbox" data-type="FA" data-bit="16"> 上限停机返回成功</label>
                    <label><input type="checkbox" data-type="FA" data-bit="17"> 白天防误扫触发</label>
                    <label><input type="checkbox" data-type="FA" data-bit="18"> 白夜状态(光线传感器状态)</label>
                    <label><input type="checkbox" data-type="FA" data-bit="19"> 运行结束（含正常异常停止）</label>
                    <label><input type="checkbox" data-type="FA" data-bit="20"> 有无授权</label>
                    <label><input type="checkbox" data-type="FA" data-bit="21"> 上限停机返回原位成功</label>
                    <label><input type="checkbox" data-type="FA" data-bit="22"> 上限停机返回停机平台成功</label>
                    <label><input type="checkbox" data-type="FA" data-bit="23"> 机身卡套</label>
                    <label><input type="checkbox" data-type="FA" data-bit="24"> 机身卡套恢复</label>
                    <label><input type="checkbox" data-type="FA" data-bit="25"> 平台不允许运行</label>
                    <label><input type="checkbox" data-type="FA" data-bit="26"> 自动运行请求回复超时</label>
                </div>

                <!-- FB告警 -->
                <div class="alarm-checkboxes" id="alarm-FB" style="display: none;">
                    <label><input type="checkbox" data-type="FB" data-bit="0"> 遥控器启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="1"> app控制启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="2"> 串口控制启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="3"> scada主动控制启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="4"> 机器人定时启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="5"> 机器人异常回退请求启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="6"> 断电或者重启之后等致复启动</label>
                    <label><input type="checkbox" data-type="FB" data-bit="7"> 长时间无法通信等致重启</label>
                    <label><input type="checkbox" data-type="FB" data-bit="8"> 机器人本人入网等致重启</label>
                    <label><input type="checkbox" data-type="FB" data-bit="9"> 升级成功导致重启</label>
                    <label><input type="checkbox" data-type="FB" data-bit="10"> 命令重启</label>
                </div>

                <!-- FC告警 -->
                <div class="alarm-checkboxes" id="alarm-FC" style="display: none;">
                    <label><input type="checkbox" data-type="FC" data-bit="0"> 充放电控制器通信故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="1"> 电池包通信故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="2"> SPI存储模块通信故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="3"> 低手保护电量预警</label>
                    <label><input type="checkbox" data-type="FC" data-bit="4"> 温湿度传感器通信故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="5"> 电池电压保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="6"> 电池温度保护（高温）</label>
                    <label><input type="checkbox" data-type="FC" data-bit="7"> 电池电流保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="8"> 低电量保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="9"> 主电机上限故障（上限停机）</label>
                    <label><input type="checkbox" data-type="FC" data-bit="10"> 从电机上限故障（上限停机）</label>
                    <label><input type="checkbox" data-type="FC" data-bit="11"> 远近端无信号</label>
                    <label><input type="checkbox" data-type="FC" data-bit="12"> 自动运行超时</label>
                    <label><input type="checkbox" data-type="FC" data-bit="13"> Lora通信故障(离线)</label>
                    <label><input type="checkbox" data-type="FC" data-bit="14"> 大风保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="15"> 湿度保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="16"> 电池放电欠压</label>
                    <label><input type="checkbox" data-type="FC" data-bit="17"> 电池放电温度故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="18"> 电池放电过流</label>
                    <label><input type="checkbox" data-type="FC" data-bit="19"> 电池放电短路</label>
                    <label><input type="checkbox" data-type="FC" data-bit="20"> 电池充电过压</label>
                    <label><input type="checkbox" data-type="FC" data-bit="21"> 电池充电过温</label>
                    <label><input type="checkbox" data-type="FC" data-bit="22"> 电池超低压或者断线</label>
                    <label><input type="checkbox" data-type="FC" data-bit="23"> 电池寿命到期</label>
                    <label><input type="checkbox" data-type="FC" data-bit="24"> 角度传感器故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="25"> 二次运行超时</label>
                    <label><input type="checkbox" data-type="FC" data-bit="26"> 主末保护</label>
                    <label><input type="checkbox" data-type="FC" data-bit="27"> 环境温度故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="28"> 主板温度故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="29"> 主电机瞬时电流过大故障</label>
                    <label><input type="checkbox" data-type="FC" data-bit="30"> 从电机瞬时电流过大故障</label>
                </div>

                <!-- FD告警 -->
                <div class="alarm-checkboxes" id="alarm-FD" style="display: none;">
                    <label><input type="checkbox" data-type="FD" data-bit="0"> 主电机上限电流预警</label>
                    <label><input type="checkbox" data-type="FD" data-bit="1"> 从电机上限电流预警</label>
                    <label><input type="checkbox" data-type="FD" data-bit="2"> 电池高温预警</label>
                    <label><input type="checkbox" data-type="FD" data-bit="3"> 电池低温预警</label>
                    <label><input type="checkbox" data-type="FD" data-bit="4"> 设备掉电预警</label>
                </div>
            </div>
        </div>

        <!-- 机器人列表 -->
        <div class="robots-container">
            <!-- 统计信息 -->
            <div class="statistics">
                <div class="stat-card stat-total">
                    <div class="stat-label">总数</div>
                    <div class="stat-value" id="statTotal">0</div>
                </div>
                <div class="stat-card stat-enabled">
                    <div class="stat-label">已启用</div>
                    <div class="stat-value" id="statEnabled">0</div>
                </div>
                <div class="stat-card stat-disabled">
                    <div class="stat-label">已禁用</div>
                    <div class="stat-value" id="statDisabled">0</div>
                </div>
            </div>

            <div class="pagination-controls" style="display: none;">
                <div class="page-size-control">
                    <label for="pageSize">每页显示：</label>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span id="totalCount" style="margin-left: 15px;"></span>
                </div>
            </div>
            <div id="robotsList">
                <div class="loading">加载中...</div>
            </div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- 加载提示模态框 -->
    <div id="loadingModal" class="modal">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">处理中...</div>
        </div>
    </div>

    <!-- 机器人详情模态框 -->
    <div id="robotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>机器人详细信息</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="robotDetails">
                <div class="loading">加载中...</div>
            </div>
            <!-- 清扫记录展示区域，由 JS 在详情渲染后填充 -->
            <div id="cleanRecordsSection" style="padding: 16px 24px; display: none;"></div>
            <!-- 最近定时任务展示区域（与清扫记录并列） -->
            <div id="recentSchedulesSection" style="padding: 16px 24px; display: none;"></div>
            <!-- 所有表格统一渲染容器（置于详情底部） -->
            <div id="detailsTables" style="padding: 16px 24px; display: none;"></div>
        </div>
    </div>

    <!-- 告警设置模态框 -->
    <div id="alarmModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>告警设置 - <span id="alarmModalRobotInfo"></span></h2>
                <span class="close-btn" onclick="closeAlarmModal()">&times;</span>
            </div>
            <div id="alarmModalContent" style="padding: 20px;">
                <div class="loading">加载中...</div>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeAlarmModal()">取消</button>
                <button class="btn btn-success" onclick="saveAlarmSettings()">保存设置</button>
            </div>
        </div>
    </div>

    <script type="module" src="../js/app.js"></script>
</body>
</html>
